name: Fetch files
on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:
permissions:
  contents: write
jobs:
  fetch-and-push:
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      
      - name: Install Prettier
        run: bun add -g prettier
      
      - name: Fetch JS files with curl and format with Prettier
        run: |
          set -e
          FILE_URLS=(
            "https://webtiles.kicya.net/s/dist/game.js"
            "https://webtiles.kicya.net/s/dist/embed.js"
          )
          DEST_DIR="ordered-js"
          mkdir -p "$DEST_DIR"
      
          for ROUND in 1 2 3 4 5; do
            echo "Fetch round $ROUND"
            for URL in "${FILE_URLS[@]}"; do
              FILENAME=$(basename "$URL")
              DEST_PATH="$DEST_DIR/$FILENAME"
              echo "Fetching $URL -> $DEST_PATH"
      
              # Fetch with curl
              curl -sSL "$URL" -o "$DEST_PATH"
      
              # Format with Prettier
              echo "Formatting $FILENAME with Prettier..."
              prettier --write "$DEST_PATH" --print-width 100 --tab-width 2
            done
      
            # Commit changes
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add "$DEST_DIR"
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S GMT")
            git commit -m "$TIMESTAMP" || echo "No changes to commit"
            git push origin HEAD
      
            # Sleep 30s before next round (except last)
            if [ $ROUND -lt 5 ]; then
              echo "Sleeping 30s..."
              sleep 30
            fi
          done
